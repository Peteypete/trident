#!/bin/bash
"exec" "planck" "-c" "$(cd $(dirname ${BASH_SOURCE[0]}) && pwd)/util" "$0" "$@"
(require '[util.core :refer [sh]])
(require '[planck.core :refer [read-string]])

(let [[uname] *command-line-args*
      push-out (sh "clojure" "-Adev" "-m" "datomic.ion.dev"
                   (str {:op :push :uname uname}))
      _ (print push-out)
      deploy-cmd (get-in (read-string (str "[" push-out "]")) [1 :deploy-command])
      deploy-out (sh "bash" "-c" deploy-cmd)
      _ (print deploy-out)
      status-cmd (:status-command (read-string deploy-out))]
  (while true
    (print (sh "bash" "-c" status-cmd))
    (sh "sleep" "5")))
